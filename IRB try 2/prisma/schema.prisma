// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User management models
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // Will be hashed
  firstName String
  lastName  String
  role      Role     @relation(fields: [roleId], references: [id])
  roleId    String
  active    Boolean  @default(true)
  approved  Boolean  @default(false) // Admin approval required
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  studiesAsPI        Study[]                  @relation("PrincipalInvestigator")
  studiesAsReviewer  Study[]                  @relation("Reviewer")
  studyCoordinators  StudyCoordinator[]
  enrollments        Enrollment[]             @relation("EnrolledBy")
  documents          Document[]               @relation("UploadedBy")
  auditLogs          AuditLog[]
  aiAnalysisFeedback UserFeedback[]

  // QGenda-inspired scheduling relations
  availability       CoordinatorAvailability[]
  timeOffRequests    TimeOffRequest[]
  onCallSchedules    OnCallSchedule[]
  assignedVisits     ParticipantVisit[]       @relation("VisitCoordinator")

  @@index([email])
  @@index([roleId])
  @@index([active])
  @@index([approved])
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json // Store permissions as JSON
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String // CREATE, UPDATE, DELETE, APPROVE, etc.
  entity     String // Study, Participant, Document, User, etc.
  entityId   String
  entityName String? // Human-readable entity name
  oldValues  Json? // Previous state
  newValues  Json? // New state
  changes    Json? // Specific fields changed
  ipAddress  String?
  userAgent  String?
  metadata   Json? // Additional context
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@index([action])
}

// Existing models with updates
model Study {
  id                      String      @id @default(cuid())
  title                   String
  protocolNumber          String      @unique
  principalInvestigatorId String
  principalInvestigator   User        @relation("PrincipalInvestigator", fields: [principalInvestigatorId], references: [id])
  reviewerId              String?
  reviewer                User?       @relation("Reviewer", fields: [reviewerId], references: [id])
  status                  StudyStatus @default(DRAFT)
  type                    StudyType
  description             String
  startDate               DateTime?
  endDate                 DateTime?
  targetEnrollment        Int?
  currentEnrollment       Int         @default(0)
  irbApprovalDate         DateTime?
  irbExpirationDate       DateTime?
  riskLevel               RiskLevel   @default(MINIMAL)
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  participants      Participant[]
  enrollments       Enrollment[]
  documents         Document[]
  studyCoordinators StudyCoordinator[]
  studyVisits       StudyVisit[]
  aiAnalysis        AiAnalysis?
  similarities      ProtocolSimilarity[]

  @@index([status])
  @@index([type])
  @@index([principalInvestigatorId])
  @@index([reviewerId])
  @@index([createdAt])
}

model Participant {
  id              String            @id @default(cuid())
  studyId         String
  study           Study             @relation(fields: [studyId], references: [id])
  participantId   String            @unique
  subjectId       String // IRB subject identifier
  firstName       String?
  lastName        String?
  dateOfBirth     DateTime?
  email           String?
  phone           String?
  address         String?
  consentDate     DateTime?
  consentVersion  String?
  enrollmentDate  DateTime?
  groupAssignment String? // Treatment/Control group
  status          ParticipantStatus @default(SCREENING)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  enrollments       Enrollment[]
  participantVisits ParticipantVisit[]
  waitlist          VisitWaitlist[]

  @@unique([studyId, subjectId])
}

model Enrollment {
  id               String           @id @default(cuid())
  studyId          String
  study            Study            @relation(fields: [studyId], references: [id])
  participantId    String
  participant      Participant      @relation(fields: [participantId], references: [id])
  enrollmentDate   DateTime         @default(now())
  enrolledById     String
  enrolledBy       User             @relation("EnrolledBy", fields: [enrolledById], references: [id])
  status           EnrollmentStatus @default(ACTIVE)
  withdrawalDate   DateTime?
  withdrawalReason String?
  completionDate   DateTime?
  notes            String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@unique([studyId, participantId])
}

model Document {
  id             String         @id @default(cuid())
  studyId        String
  study          Study          @relation(fields: [studyId], references: [id])
  name           String
  type           DocumentType
  version        Int            @default(1) // Auto-incremented version number
  description    String?
  filePath       String
  fileSize       Int
  mimeType       String
  uploadedById   String
  uploadedBy     User           @relation("UploadedBy", fields: [uploadedById], references: [id])
  status         DocumentStatus @default(ACTIVE)
  approvalDate   DateTime?
  expirationDate DateTime?

  // OCR fields
  ocrContent     String? // Extracted text content from OCR
  ocrStatus      String? // pending, processing, completed, failed, not_supported
  ocrError       String? // Error message if OCR failed
  ocrModel       String? // Model used for OCR (e.g., "claude-3-5-sonnet-20241022")
  ocrProcessedAt DateTime? // When OCR was completed
  isOcrSupported Boolean   @default(false) // Whether file type supports OCR

  // Document versioning
  parentDocumentId String? // Links to previous version of same document
  isLatestVersion  Boolean @default(true) // Only latest version is true
  versionNotes     String? // Notes about what changed in this version

  // Aigents integration fields
  aigentsChainName   String?
  aigentsRunId       String?
  aigentsStatus      String? // pending, processing, completed, failed
  aigentsAnalysis    String? // AI analysis result
  aigentstartedAt    DateTime?
  aigentsCompletedAt DateTime?
  aigentsError       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  automationLogs AutomationLog[]

  @@index([studyId])
  @@index([parentDocumentId])
  @@index([aigentsRunId])
  @@index([aigentsStatus])
  @@index([ocrStatus])
  @@index([isLatestVersion])
}

// Automation/Webhook tracking
model AutomationLog {
  id         String @id @default(cuid())
  chainName  String // "Protocol analyzer", "Consent Form Reviewer", etc.
  chainRunId String @unique // THE KEY - links request to webhook response

  // Relations
  documentId  String?
  document    Document? @relation(fields: [documentId], references: [id])
  studyId     String?
  requestedBy String? // User ID who triggered

  // Request tracking
  requestData String? // JSON string of what we sent
  requestedAt DateTime @default(now())

  // Response tracking
  webhookPayload  String? // JSON string of complete webhook received
  agentResponse   String? // Parsed response text
  agentReceivedAt DateTime?

  // Status
  isCompleted  Boolean @default(false)
  status       String  @default("processing") // processing|completed|failed
  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([chainRunId])
  @@index([documentId])
  @@index([studyId])
  @@index([isCompleted])
  @@index([status])
  @@index([createdAt])
}

// Enums
enum StudyStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  ACTIVE
  SUSPENDED
  CLOSED
  COMPLETED
}

enum StudyType {
  INTERVENTIONAL
  OBSERVATIONAL
  REGISTRY
  SURVEY
  OTHER
}

enum RiskLevel {
  MINIMAL
  MODERATE
  HIGH
}

enum ParticipantStatus {
  SCREENING
  ENROLLED
  ACTIVE
  COMPLETED
  WITHDRAWN
  LOST_TO_FOLLOWUP
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  WITHDRAWN
  TERMINATED
}

enum DocumentType {
  PROTOCOL
  CONSENT_FORM
  AMENDMENT
  APPROVAL_LETTER
  ADVERSE_EVENT
  PROGRESS_REPORT
  OTHER
}

enum DocumentStatus {
  DRAFT
  ACTIVE
  SUPERSEDED
  EXPIRED
}

// Coordinator-Study Assignment (Many-to-Many)
model StudyCoordinator {
  id            String   @id @default(cuid())
  studyId       String
  study         Study    @relation(fields: [studyId], references: [id], onDelete: Cascade)
  coordinatorId String
  coordinator   User     @relation(fields: [coordinatorId], references: [id], onDelete: Cascade)
  assignedAt    DateTime @default(now())
  assignedBy    String // User ID who made the assignment
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([studyId, coordinatorId])
  @@index([studyId])
  @@index([coordinatorId])
  @@index([active])
}

// Future: Visit Schedule Management
model StudyVisit {
  id              String   @id @default(cuid())
  studyId         String
  study           Study    @relation(fields: [studyId], references: [id], onDelete: Cascade)
  visitNumber     Int
  visitName       String
  visitType       String // Screening, Baseline, Follow-up, etc.
  windowDays      Int? // Visit window (+/- days)
  description     String?
  expectedPayment Float? // Payment for this visit
  procedures      String? // JSON string of procedures/tests
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  participantVisits ParticipantVisit[]
  waitlist          VisitWaitlist[]

  @@index([studyId])
  @@index([visitNumber])
}

// Future: Track actual participant visits
model ParticipantVisit {
  id            String      @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  studyVisitId  String
  studyVisit    StudyVisit  @relation(fields: [studyVisitId], references: [id], onDelete: Cascade)
  scheduledDate DateTime?
  completedDate DateTime?
  status        String      @default("scheduled") // scheduled, completed, missed, cancelled
  notes         String?
  paymentIssued Boolean     @default(false)
  paymentAmount Float?
  clinicalData  String? // JSON string for visit-specific clinical data

  // QGenda-inspired scheduling enhancements
  coordinatorId        String?
  assignedCoordinator  User?              @relation("VisitCoordinator", fields: [coordinatorId], references: [id])
  schedulingMethod     String?            @default("manual") // manual, auto, self_scheduled
  schedulingScore      Float?             // AI confidence in schedule optimality
  remindersSent        Int                @default(0)
  lastReminderAt       DateTime?
  checkInTime          DateTime?
  checkOutTime         DateTime?
  waitTime             Int?               // minutes
  noShowReason         String?
  rescheduledFrom      String?            // Previous visit ID
  rescheduledTo        String?            // New visit ID

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  facilityBookings     FacilityBooking[]

  @@index([participantId])
  @@index([studyVisitId])
  @@index([coordinatorId])
  @@index([status])
  @@index([scheduledDate])
  @@index([schedulingMethod])
}

// AI-Powered Protocol Analysis Models
model AiAnalysis {
  id      String @id @default(cuid())
  studyId String @unique
  status  String // pending, processing, completed, failed
  model   String // gpt-4o, claude-3.5-sonnet

  // Results
  studyMetadata    String? // JSON string of study metadata
  executiveSummary String?
  complexityScore  Int? // 1-10 scale
  complianceScore  Int? // 0-100 percentage
  riskLevel        String? // low, medium, high, critical
  processingTimeMs Int?
  errorMessage     String?

  // Phase 3: Protocol Similarity (Vector embeddings)
  embedding        String? // JSON array of embedding vector (1536 dimensions for text-embedding-3-large)
  embeddingModel   String? // text-embedding-3-large
  embeddingCreated DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  study            Study                @relation(fields: [studyId], references: [id], onDelete: Cascade)
  criteria         Criterion[]
  visitSchedule    VisitSchedule[]
  budgetEstimate   BudgetEstimate?
  complianceChecks ComplianceCheck[]
  similarities     ProtocolSimilarity[] @relation("SourceAnalysis")
  userFeedback     UserFeedback[]

  @@index([studyId])
  @@index([status])
  @@index([createdAt])
}

model Criterion {
  id            String  @id @default(cuid())
  aiAnalysisId  String
  type          String // inclusion, exclusion
  category      String // age, medical_history, medication, laboratory, etc.
  description   String
  originalText  String
  logicOperator String? // AND, OR, NOT
  priority      Int     @default(0)
  confidence    Float? // AI confidence score (0.0-1.0)

  createdAt  DateTime   @default(now())
  aiAnalysis AiAnalysis @relation(fields: [aiAnalysisId], references: [id], onDelete: Cascade)

  @@index([aiAnalysisId])
  @@index([type])
  @@index([category])
}

model VisitSchedule {
  id           String  @id @default(cuid())
  aiAnalysisId String
  visitName    String
  visitNumber  Int
  dayRange     String // "Day 0", "Week 1", "Month 3"
  procedures   String // JSON array of procedures/assessments
  duration     String?
  notes        String?

  createdAt  DateTime   @default(now())
  aiAnalysis AiAnalysis @relation(fields: [aiAnalysisId], references: [id], onDelete: Cascade)

  @@index([aiAnalysisId])
  @@index([visitNumber])
}

model BudgetEstimate {
  id                 String  @id @default(cuid())
  aiAnalysisId       String  @unique
  totalEstimate      Float // Total estimated cost
  perParticipantCost Float // Cost per participant
  breakdown          String // JSON breakdown by category
  assumptions        String?

  createdAt  DateTime   @default(now())
  aiAnalysis AiAnalysis @relation(fields: [aiAnalysisId], references: [id], onDelete: Cascade)

  @@index([aiAnalysisId])
}

model ComplianceCheck {
  id             String  @id @default(cuid())
  aiAnalysisId   String
  regulation     String // FDA_21CFR11, ICH_GCP, HIPAA, etc.
  status         String // compliant, non_compliant, needs_review
  finding        String
  recommendation String?
  severity       String // low, medium, high, critical

  createdAt  DateTime   @default(now())
  aiAnalysis AiAnalysis @relation(fields: [aiAnalysisId], references: [id], onDelete: Cascade)

  @@index([aiAnalysisId])
  @@index([regulation])
  @@index([status])
  @@index([severity])
}

model ProtocolSimilarity {
  id              String @id @default(cuid())
  aiAnalysisId    String
  similarStudyId  String
  similarityScore Float // 0.0 to 1.0
  matchingAspects String // JSON of what aspects are similar

  createdAt    DateTime   @default(now())
  aiAnalysis   AiAnalysis @relation("SourceAnalysis", fields: [aiAnalysisId], references: [id], onDelete: Cascade)
  similarStudy Study      @relation(fields: [similarStudyId], references: [id], onDelete: Cascade)

  @@index([aiAnalysisId])
  @@index([similarStudyId])
  @@index([similarityScore])
}

model UserFeedback {
  id            String  @id @default(cuid())
  aiAnalysisId  String
  userId        String
  feedbackType  String // accuracy, completeness, usefulness
  rating        Int // 1-5
  comment       String?
  correctedData String? // JSON user corrections for retraining

  createdAt  DateTime   @default(now())
  aiAnalysis AiAnalysis @relation(fields: [aiAnalysisId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id])

  @@index([aiAnalysisId])
  @@index([userId])
  @@index([feedbackType])
  @@index([rating])
}

// Phase 3: Historical Data Analysis
model HistoricalMetric {
  id              String  @id @default(cuid())
  studyId         String
  metricType      String // enrollment_rate, dropout_rate, completion_time, budget_accuracy
  metricValue     Float
  timeframe       String // "2023-Q1", "2024-Jan", etc.
  phase           String? // Phase I, II, III, IV
  therapeuticArea String?
  notes           String?

  createdAt DateTime @default(now())

  @@index([studyId])
  @@index([metricType])
  @@index([timeframe])
  @@index([phase])
  @@index([therapeuticArea])
}

// Phase 4: Real-time Collaboration
model ProtocolComment {
  id           String    @id @default(cuid())
  studyId      String
  userId       String
  section      String // Which section/field this comment refers to
  content      String
  resolved     Boolean   @default(false)
  resolvedById String?
  resolvedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studyId])
  @@index([userId])
  @@index([resolved])
  @@index([section])
}

model ProtocolVersion {
  id              String  @id @default(cuid())
  studyId         String
  versionNumber   Int
  changes         String // JSON string of changes
  changedBy       String // User ID
  changeType      String // major, minor, patch
  changeNotes     String?
  previousVersion String? // ID of previous version

  createdAt DateTime @default(now())

  @@unique([studyId, versionNumber])
  @@index([studyId])
  @@index([versionNumber])
  @@index([createdAt])
}

model CollaborationSession {
  id           String   @id @default(cuid())
  studyId      String
  activeUsers  String // JSON array of user IDs currently viewing/editing
  lastActivity DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studyId])
  @@index([lastActivity])
}

// ============================================
// QGenda-Inspired Scheduling Models
// ============================================

// Coordinator Availability Management
model CoordinatorAvailability {
  id            String   @id @default(cuid())
  coordinatorId String
  coordinator   User     @relation(fields: [coordinatorId], references: [id], onDelete: Cascade)
  dayOfWeek     Int      // 0-6 (Sunday-Saturday)
  startTime     String   // "09:00"
  endTime       String   // "17:00"
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isRecurring   Boolean  @default(true)
  timezone      String   @default("America/New_York")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([coordinatorId])
  @@index([dayOfWeek])
  @@index([effectiveFrom])
}

// Time Off Request Management
model TimeOffRequest {
  id            String    @id @default(cuid())
  coordinatorId String
  coordinator   User      @relation(fields: [coordinatorId], references: [id], onDelete: Cascade)
  startDate     DateTime
  endDate       DateTime
  requestType   String    // PTO, sick, personal, conference, etc.
  status        String    @default("pending") // pending, approved, denied
  reason        String?
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([coordinatorId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

// Facility Resource Management
model Facility {
  id          String   @id @default(cuid())
  name        String
  type        String   // exam_room, lab, office, conference_room
  location    String
  building    String?
  floor       String?
  capacity    Int      @default(1)
  equipment   String?  // JSON array of available equipment
  hoursOfOp   String?  // JSON object with operating hours
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  bookings FacilityBooking[]

  @@index([type])
  @@index([active])
  @@index([location])
}

model FacilityBooking {
  id               String            @id @default(cuid())
  facilityId       String
  facility         Facility          @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  participantVisit String?
  visit            ParticipantVisit? @relation(fields: [participantVisit], references: [id], onDelete: SetNull)
  startTime        DateTime
  endTime          DateTime
  purpose          String
  bookedBy         String
  status           String            @default("booked") // booked, completed, cancelled
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([facilityId])
  @@index([participantVisit])
  @@index([startTime])
  @@index([status])
}

// On-Call Schedule Management
model OnCallSchedule {
  id            String   @id @default(cuid())
  coordinatorId String
  coordinator   User     @relation(fields: [coordinatorId], references: [id], onDelete: Cascade)
  startDateTime DateTime
  endDateTime   DateTime
  scheduleType  String   // weekday, weekend, holiday, emergency
  priority      Int      @default(1) // 1=primary, 2=backup, 3=tertiary
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([coordinatorId])
  @@index([startDateTime])
  @@index([scheduleType])
  @@index([priority])
}

// Visit Waitlist Management
model VisitWaitlist {
  id            String      @id @default(cuid())
  participantId String
  participant   Participant @relation(fields: [participantId], references: [id], onDelete: Cascade)
  studyVisitId  String
  studyVisit    StudyVisit  @relation(fields: [studyVisitId], references: [id], onDelete: Cascade)
  addedAt       DateTime    @default(now())
  priority      Int         @default(5) // 1-10 (1=highest)
  preferences   String?     // JSON object for time/day preferences
  contacted     Boolean     @default(false)
  contactedAt   DateTime?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([studyVisitId])
  @@index([participantId])
  @@index([priority])
  @@index([contacted])
  @@index([addedAt])
}

// Scheduling Analytics Cache
model SchedulingMetric {
  id               String    @id @default(cuid())
  metricDate       DateTime
  coordinatorId    String?
  studyId          String?

  // Visit Metrics
  scheduledVisits  Int       @default(0)
  completedVisits  Int       @default(0)
  cancelledVisits  Int       @default(0)
  noShowVisits     Int       @default(0)
  rescheduledVisits Int      @default(0)

  // Efficiency Metrics
  utilizationRate  Float?    // 0.0 - 1.0
  avgWaitTime      Float?    // minutes
  avgVisitDuration Float?    // minutes
  avgSchedulingTime Float?   // minutes to schedule

  // Capacity Metrics
  availableSlots   Int       @default(0)
  bookedSlots      Int       @default(0)
  capacityRate     Float?    // 0.0 - 1.0

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([metricDate, coordinatorId, studyId])
  @@index([metricDate])
  @@index([coordinatorId])
  @@index([studyId])
}
